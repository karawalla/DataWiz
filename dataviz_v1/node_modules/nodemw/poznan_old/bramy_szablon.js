var SUMMARY = 'Dodano infobox',
	template = "{{Brama infobox\n";

var bot = require('../lib/bot').bot;

var client = new bot({
	server: 'poznan.wikia.com',
	//debug: true
});

// log in
client.logIn('Pyrabot', 'pyr4pyr4', function(data) {
	client.getPagesInCategory('Bramy średniowieczne', function(pages) {

		pages && pages.forEach(function(page) {
			// ignore pages outside main namespace
			if (page.ns != 0) {
				return;
			}

			client.getArticle(page.title, function(content) {
				// dodano już szablon
				if (content.indexOf(template) > -1) {
					return;
				}

				// place
				place = content.match(/\s?<place(.*)>\s?/);

				if (place && place[0]) {
					content = content.replace(place[0], '');
				}

				// dodaj infobox
				content = template +
					"|nazwa=" + page.title + "\n" +
					"|mapa=" + ((place && place[0].trim()) || '') + "\n" +
					"|zbudowana=\n" +
					"|zburzona=\n" +
					"}}\n" +
					content;

				console.log('\n\n================================\n' + page.title + '\n================================');
				console.log(content);

				// and save it
				/**/
				client.edit(page.title, content, SUMMARY, function(data) {
					console.log('\n\n> ' + page.title + ' edited!');
				});
				/**/
			});
		});
	});
});
