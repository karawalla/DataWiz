var SUMMARY = 'Dodano długość ulicy',
	regexp = /\s\|dzielnice/;

var bot = require('../lib/bot').bot;

var client = new bot({
	server: 'poznan.wikia.com',
	//debug: true
});

// log in
client.logIn('Pyrabot', 'pyr4pyr4', function(data) {
	console.log('Logged in as ' + data.lgusername + ' (session ID: ' + data.sessionid + ')');

	var db = JSON.parse( require('fs').readFileSync('../../ulice.json', 'utf-8') );

	//console.log(db); return;

	client.getPagesInCategory('Brakująca długość ulicy', function(pages) {
		var i = 0,
			len = pages.length;

		pages && pages.forEach(function(page) {
			// ignore pages outside main namespace
			if (page.ns != 0) {
				return;
			}

			i++;

			// pobierz długość ulicy
			var length = db[ page.title.
				replace(/^Ulica /, '').
				replace(/Świętej/, 'św.').
				replace(/Świętego/, 'św.').
				replace(/Księdza/, 'ks.').
				toLowerCase() ];

			if (!length) {
				console.log("\n" + (i+1) + "/" + len + ": " + page.title + " - No length entry!");
				return;
			}

			//console.log(page.title); return;

			//if (i>20) return;

			client.getArticle(page.title, function(content) {
				console.log("\n" + page.title);

				// jednostka
				length += ' m';

				content = content.replace(regexp, "\n|długość=" + length + "\n|dzielnice");

				console.log('\n\n================================\n' + page.title + '\n================================');
				console.log(content);

				// and save it
				/**/
				try {
					client.edit(page.title, content, SUMMARY, function(data) {
						console.log('\n\n> ' + page.title + ' edited!');
					});
				} catch(e) {
					console.log(e);
				}
				/**/
			});
		});

		console.log("\n\nDone");
	});
});
