(function(e){e.freebase=function(){var t=function(){function t(t){console.log(t),e("body").append(JSON.stringify(t))}function i(e){try{return JSON.parse(e)}catch(t){return e}}var o={};if("undefined"!=typeof window&&window.screen)o.get=function(o,r){r=r||t,e.get(o,function(e){r(i(e))}).fail(function(e){r(e.statusText||"error")})},o.jsonp=function(o,r){r=r||t,e.getJSON(o,function(e){r(i(e))}).fail(function(e){r(e.statusText||"error")})},o.post=function(o,r,n){n=n||t,e.post(o,r,function(e){n(i(e))}).fail(function(e){n(e.statusText||"error")})};else if("undefined"!=typeof module&&module.exports){var r=require("request");o.get=function(e,t){t=t||console.log,r({uri:e},function(e,o,r){t(i(r))})},o.post=function(e,t,o){o=o||console.log,"object"==typeof t&&(t=JSON.stringify(t)),r({url:"http://api.freebase.com/api/service/mqlread",method:"POST",body:t},function(e,t,r){o(i(r))})}}return"undefined"!=typeof define&&define.amd?define([],function(){return o}):"undefined"!=typeof module&&module.exports&&(module.exports=o),o}(),i=function(){var e={kill:["/music/track","/music/release_track","/tv/tv_episode","/music/recording","/music/composition","/book/book_edition"],boring:["/type/object/attribution","/type/object/key","/type/object/mid","/common/topic/notable_properties","/type/object/guid","/type/object/type","/type/object/id","/type/object/creator","/type/object/timestamp","/type/object/permission","/common/topic/alias","/common/topic/article","/common/topic/image","/common/topic/notable_for","/common/topic/notable_types","/common/topic/official_website","/common/topic/topic_equivalent_webpage","/common/topic/topical_webpage","/travel/travel_destination_monthly_climate/month","/location/religion_percentage/religion"],sentence_grammars:[],plural_types:["/music/instrument","/business/product_category","/biology/animal","/aviation/aircraft_type","/base/aareas/schema/administrative_area_type","/user/spencermountain/default_domain/type_of_music_group","/geography/geographical_feature_category","/award/award_discipline","/fashion/garment","/interests/collection_category","/organization/organization_type","/geology/rock_type","/sports/sports_equipment","/fictional_universe/fictional_organization_type","/user/jamie/default_domain/retail_category","/base/localfood/produce","/base/disaster2/type_of_injury","/architecture/type_of_museum","/automotive/engine_type","/travel/accommodation_feature","/transportation/bridge_type","/food/type_of_dish","/automotive/automotive_class","/geography/mountain_type","/exhibitions/type_of_exhibition","/user/alecf/recreation/park_feature","/event/disaster_type","/meteorology/cloud","/base/events/type_of_festival","/american_football/football_position","/base/piercings/piercing_location","/religion/type_of_place_of_worship","/base/birdinfo/type_of_diet","/astronomy/type_of_planetographic_feature","/base/forts/type_of_fort","/travel/accommodation_type","/base/crime/lawyer_type","/base/argumentmaps/type_of_joke","/base/events/type_of_performance","/event/type_of_public_presentation","/user/alexander/toys/toy_type","/user/robert/mobile_phones/input_interface","/baseball/baseball_position","/theater/theater_production_staff_role","/soccer/football_position","/music/voice","/base/disaster2/type_of_injury_causing_event","/base/services/exercise_facilities","/conferences/type_of_conference","/base/ecology/type_of_ecosystem","/bicycles/bicycle_type","/basketball/basketball_position","/base/movietheatres/type_of_movie_theatre_cinema","/base/disaster2/type_of_automobile_accident","/ice_hockey/hockey_position","/base/fires/type_of_fire","/base/crime/type_of_criminal_organization","/base/skateboarding/type_of_skateboarding_obstacle","/spaceflight/satellite_type","/base/represent/type_of_agent","/user/rcheramy/default_domain/fruit","/user/rcheramy/default_domain/food","/biology/organism_classification","/business/job_title","/medicine/anatomical_structure","/people/profession","/fictional_universe/character_species","/user/rcheramy/default_domain/hockey_team","/ice_hockey/hockey_team","/sports/sports_team","/sports/professional_sports_team","/base/events/event_presenting_organisation","/film/film_genre","/music/compositional_form","/medicine/drug_class","/geography/lake_type","/user/akatenev/weapons/weapon","/user/spencermountain/default_domain/stock_character","/base/folklore/mythical_creature"],category_like:["/american_football/football_position/players","/architecture/architectural_style/architects","/baseball/baseball_position/players","/basketball/basketball_position/players","/basketball/basketball_roster_position/player","/business/competitive_space_mediator/company","/business/industry/companies","/business/market_share/company","/comic_strips/comic_strip_creator_duration/creator_of_strip","/dining/cuisine/chefs","/dining/cuisine/restaurant","/education/education/student","/education/field_of_study/academic_departments","/education/field_of_study/academics_in_this_field","/film/film_film_company_relationship/film_company","/food/diet/followers","/ice_hockey/hockey_position/players","/interests/hobby/people_with_this_hobby","/interests/interest/people_with_this_interest","/martial_arts/martial_art/well_known_practitioner","/medicine/medical_specialty/hospitals_with_this_specialty","/medicine/medical_specialty/physicians_with_this_specialty","/music/genre/artists","/music/group_membership/member","/music/recording_contribution/contributor","/music/track_contribution/contributor","/olympics/olympic_athlete_affiliation/athlete","/opera/opera_designer_gig/designer","/opera/opera_production_staff_gig/staff_member","/organization/club_interest/clubs","/organization/leadership/person","/organization/organization_board_membership/member","/organization/organization_sector/organizations_in_this_sector","/people/profession/people_with_this_profession","/projects/project_participation/participant","/religion/religion/organizations","/soccer/football_position/players","/sports/pro_sports_played/athlete","/sports/sport/leagues","/sports/sport/officials","/sports/sport/team_coaches","/sports/sport/teams","/sports/sports_team_roster/player","/theater/theater_designer_gig/designer","/theater/theater_production_staff_gig/staff_member","/tv/tv_crew_gig/crewmember","/tv/tv_producer_episode_credit/producer","/tv/tv_producer_term/producer","/tv/tv_regular_personal_appearance/person","/visual_art/visual_art_form/artists","/government/form_of_government/countries","/people/ethnicity/people","/fictional_universe/character_gender","/fictional_universe/fictional_character/ethnicity","/architecture/structure/architectural_style","/book/book/genre","/book/magazine/genre","/book/short_story/genre","/book/written_work/school_or_movement","/broadcast/content/genre","/broadcast/radio_station/format","/comic_books/comic_book_series/genre","/comic_books/comic_book_story/genre","/comic_strips/comic_strip/genre","/computer/software/software_genre","/cvg/computer_videogame/cvg_genre","/film/film/genre","/food/dish/cuisine","/games/game/genre","/internet/website/category","/media_common/netflix_title/netflix_genres","/music/album/genre","/music/music_video/music_video_genre","/opera/opera/genre","/theater/play/genre","/tv/tv_program/genre","/visual_art/artwork/art_genre","/visual_art/artwork/period_or_movement","/automotive/model/model_years","/automotive/model_year/examples","/aviation/aircraft_model/aircraft","/award/recurring_competition/individual_competitions","/conferences/conference_series/conference","/cricket/cricket_series/series_events","/cricket/cricket_tournament/events","/film/film_festival/individual_festivals","/food/dish/recipes","/rail/locomotive_class/locomotives_of_this_class","/sports/sports_championship/events","/sports/tournament_event/competitions","/time/recurring_event/instances","/fictional_universe/character_occupation/characters_with_this_occupation"],related_properties:["/influence/influence_node/influenced_by","/location/location/adjoin_s","/influence/influence_node/influenced","/location/location/coterminous_with","/location/location/near","/time/event/included_in_event","/time/event/includes_event","/film/film/subjects","/film/film/sequel","/film/film/prequel","/film/film/directed_by","/film/film/starring","/book/written_work/previous_in_series","/book/written_work/next_in_series","/book/written_work/subjects","/visual_art/artwork/art_subject","/visual_art/artwork/belongs_to_series","/education/educational_institution/subsidiary_or_constituent_schools","/education/educational_institution/parent_institution","/organization/organization/sectors","/organization/organization/spun_off_from","/organization/organization/spin_offs","/organization/organization/parent","/organization/organization/child","/biology/organism_classification/higher_classification","/biology/organism_classification/lower_classifications","/biology/organism_classification/child_classifications","/biology/organism_classification/parent_classifications","/sports/sports_facility/teams","/sports/sports_league/championship","/sports/sport/leagues","/sports/sports_team/arena_stadium","/sports/sports_team/location","/sports/sports_team_location/teams","/government/political_party/ideology","/government/political_district/elections","/government/election/winner","/music/track/artist","/time/recurring_event/instances","/people/profession/specializations","/people/profession/specialization_of","/music/artist/label","/music/artist/album","/music/release/label","/music/release/album","/music/album/artist","/music/musical_group/member","/music/producer/releases_produced","/base/onephylogeny/type_of_thing/includes","/base/onephylogeny/type_of_thing/included_in","/location/country/capital","/location/country/form_of_government","/location/country/currency_used","/location/country/national_anthem","/aviation/airport/serves","/architecture/structure/architect","/geography/lake/cities","/geography/lake/outflow","/geography/lake/inflow","/olympics/olympic_games/host_city","/olympics/olympic_host_city","/business/employment_tenure/company","/film/performance/film","/tv/regular_tv_appearance/series","/people/marriage/spouse","/education/education/specialization","/education/education/major_field_of_study","/location/adjoining_relationship/adjoins","/music/group_membership/group","/celebrities/friendship/friend","/base/popstra/friendship/participant","/people/person/parents","/influence/influence_node/peers","/people/person/children","/people/sibling_relationship/sibling","/location/location/contains"],definate_articles:["/geography/mountain_range","/location/region","/royalty/noble_title","/user/pak21/default_domain/tectonic_plate","/education/university","/education/department","/religion/religious_organization","/user/robinboast/default_domain/historical_period","/travel/tourist_attraction","/comic_books/comic_book_character","/transportation/bridge","/business/shopping_center","/base/argumentmaps/intellectual_dispute","/base/argumentmaps/argument","/geography/island_group"],properties:[],is_a:["/amusement_parks/ride/ride_type","/amusement_parks/roller_coaster/propulsion","/amusement_parks/roller_coaster/train_configuration","/architecture/building/building_function","/architecture/museum/type_of_museum","/astronomy/asteroid/spectral_type","/astronomy/celestial_object/category","/astronomy/extraterrestrial_location/type_of_planetographic_feature","/astronomy/galaxy/galaxy_classification_hubble","/astronomy/galaxy_classification_code/galaxy_shape","/astronomy/near_earth_object/near_earth_object_classification","/astronomy/orbital_relationship/orbit_type","/astronomy/star/spectral_type","/astronomy/telescope/type_of_telescope","/automotive/model/automotive_class","/automotive/transmission/classification","/aviation/aircraft_model/aircraft_type","/aviation/airliner_accident/accident_type","/aviation/airport/airport_type","/aviation/aviation_waypoint/waypoint_type","/award/competition/type_of_competition","/bicycles/bicycle_model/bicycle_type","/biology/breed_registration/breed_group","/biology/fossil_specimen/organism","/biology/gene_group_membership/group","/biology/gene_ontology_group/group_type","/biology/organism/organism_type","/biology/organism/sex","/biology/organism_classification/rank","/biology/pedigreed_animal/breed","/boats/ship/ship_class","/boats/ship_class/ship_type","/book/book_edition/binding","/book/periodical_format_period/format","/book/poem/verse_form","/book/short_non_fiction/mode_of_writing","/business/consumer_product/category","/business/issue/type_of_issue","/business/product_line/category","/celebrities/sexual_orientation_phase/sexual_orientation","/chemistry/chemical_compound/classifications","/chemistry/chemical_element/chemical_series","/chemistry/chemical_element/periodic_table_block","/computer/computer_peripheral/peripheral_class","/computer/file_format/genre","/conferences/conference_series/type_of_conference","/cricket/cricket_match/match_type","/cvg/computer_videogame/gameplay_modes","/digicams/digital_camera/format","/distilled_spirits/blended_spirit/style","/distilled_spirits/distilled_spirit/spirit_type","/distilled_spirits/infused_spirit/infusion_style","/education/educational_institution/school_type","/education/fraternity_sorority/fraternity_sorority_type","/engineering/battery/cell_type","/engineering/battery/size","/engineering/battery_size/shape_format","/engineering/engine/category","/engineering/piston_engine/cooling_method","/engineering/piston_engine/fuel_delivery_method","/engineering/piston_engine/piston_configuration","/engineering/piston_engine/valvetrain_configuration","/engineering/power_plug_standard/plug_type","/event/disaster/type_of_disaster","/event/speech_or_presentation/type_or_format_of_presentation","/exhibitions/exhibition/exhibition_types","/fashion/textile/weave","/fictional_universe/fictional_setting/setting_type","/film/film/film_format","/food/beer/beer_style","/food/beer_style/bjcp_style_category","/food/cheese/texture","/food/dish/type_of_dish1","/food/drinking_establishment/drinking_establishment_type","/food/tea/tea_type","/food/wine_style/wine_types","/geography/geographical_feature/category","/geography/glacier/glacier_type","/geography/lake/lake_type","/geography/mountain/listings","/geography/mountain/mountain_type","/geography/waterfall/waterfall_type","/government/government_office_or_title/category","/government/government_position_held/basic_title","/interests/collectable_item/collection_category","/internet/top_level_domain/domain_type","/language/conlang/conlang_type","/language/language_writing_system/type_of_writing","/law/us_patent/international_classification","/law/us_patent/us_classification_category","/law/us_patent/us_patent_type","/location/administrative_division_capital_relationship/capital_type","/location/country/form_of_government","/location/location_symbol_relationship/Kind_of_symbol","/martial_arts/martial_art/category","/medicine/cancer_center/cancer_center_type","/medicine/drug/drug_class","/medicine/drug/mechanism_of_action","/medicine/drug_formulation/dosage_form","/medicine/drug_formulation/drug_category","/medicine/hospital_ownership/ownership_status","/medicine/infectious_disease/infectious_agent_type","/medicine/medical_trial/design","/medicine/medical_trial/phase","/medicine/medical_trial/type_of_trial","/meteorology/cloud/classification","/meteorology/tropical_cyclone/category","/metropolitan_transit/transit_line/service_type","/military/military_unit/unit_size","/music/album/release_type","/music/composition/form","/music/opera_singer/voice_type","/music/release/format","/organization/organization/legal_structure","/organization/organization/organization_type","/people/person/ethnicity","/people/person/gender","/physics/particle/family","/physics/particle/generation","/protected_sites/natural_or_cultural_site_designation/categories","/protected_sites/natural_or_cultural_site_listing/designation","/protected_sites/protected_site/iucn_category","/rail/locomotive_class/gauge","/rail/railway_gauge_relationship/gauge","/rail/railway_type_relationship/railway_type","/rail/steam_locomotive_class/fuel_type","/rail/steam_locomotive_class/wheel_configuration","/religion/place_of_worship/religion","/religion/place_of_worship/type_of_place_of_worship","/religion/place_of_worship_historical_use/religion","/religion/religious_leadership_jurisdiction/size_or_type","/royalty/chivalric_rank/gender","/royalty/noble_rank/gender","/royalty/order_of_chivalry/category","/skiing/lift_tenure/lift_type","/skiing/ski_run/rating","/spaceflight/bipropellant_rocket_engine/engine_cycle","/spaceflight/rocket/rocket_function","/spaceflight/satellite/primary_use","/sports/boxer/weight_division","/time/holiday/type_of_holiday","/transportation/bridge/bridge_type","/travel/accommodation/accommodation_type","/visual_art/artwork/art_form","/wine/wine/color","/wine/wine/wine_style","/wine/wine/wine_type","/zoos/zoo/category","/people/person/profession","/soccer/football_player/position_s","/american_football/football_historical_roster_position/position_s","/american_football/football_player/position_s","/american_football/football_roster_position/position","/baseball/baseball_player/position_s","/baseball/baseball_roster_position/position","/basketball/basketball_player/position_s","/basketball/basketball_roster_position/position","/ice_hockey/hockey_player/hockey_position","/ice_hockey/hockey_roster_position/position","/soccer/football_player/position_s","/soccer/football_roster_position/position"]};return"undefined"!=typeof define&&define.amd?define([],function(){return e}):"undefined"!=typeof module&&module.exports&&(module.exports={data:e}),e}();if("undefined"!=typeof module&&module.exports)var o=require("underscore"),r=require("async"),i=require("./data.js").data,t=require("./http.js");var n=function(){var e=10,n={};return n.compact_strong=function(e){return o.unique(o.compact(e)).filter(function(e){return 0==o.isEmpty(e)})},n.settle_params=function(e,t,i){var r={valid:!1,q:e[0],options:e[1]||{},callback:e[2]||console.log,defaults:i||{},method:t||""};if("function"==typeof r.options&&(r.callback=r.options,r.options={}),r.options.verbose){var a=r.callback;r.callback=function(e){return console.log("hi"),a(e)}}if(o.isArray(r.q)){if(r.q.length>1)return r.q=n.compact_strong(r.q),r.valid=!0,r.array=!0,r;r.q=r.q[0]}if(o.isObject(r.q)&&(r.q=r.q.id||r.q.mid||r.q.name),"string"!=typeof r.q||"object"!=typeof r.options||"function"!=typeof r.callback)return r;r.q.match(/\/.*?\/.*?/)&&(r.is_id=!0);for(var s in r.defaults)r.options[s]=r.options[s]||r.defaults[s];return r.q=r.q.replace(/  /," "),r.q=r.q.replace(/^\s+|\s+$/,""),r.q.match(/^(https?:\/\/|www\.)/)&&(r.q=r.q.replace(/\/$/,""),r.q=r.q.replace(/^https/,"http"),r.url=!0),r.valid=!0,r},n.topk=function(e,t){var i=[];t=t||1;for(var o,r={},o=e.length-1;o>-1;o--){var n=e[o];null==r[n]?r[n]=1:r[n]++}for(var n in r)i.push(n);return i.sort(function(e,t){return r[t]-r[e]}).map(function(e){return{value:e,count:r[e],percentage:(100*(r[e]/t)).toFixed(2)}})},n.percentage=function(e,t){return parseInt(100*(e/t))},n.kill_boring=function(e){return e?(i.boring.forEach(function(t){delete e[t]}),e):{}},n.parse_topic_api=function(e){var t=[];return e=n.kill_boring(e),Object.keys(e).forEach(function(i){var o=e[i];"object"==o.valuetype&&(o.values=o.values.map(function(e){return e.property=i,e}),t=t.concat(o.values)),"compound"==o.valuetype&&o.values.forEach(function(e){e.property=n.kill_boring(e.property),Object.keys(e.property).forEach(function(o){"object"==e.property[o].valuetype&&(e.property[o].values=e.property[o].values.map(function(e){return e.property=[i,o],e}),t=t.concat(e.property[o].values))})})}),t=t.map(function(e){return{name:e.text,id:e.id,property:e.property}}),t=t.map(function(e){return o.isArray(e.property)&&(e.property=e.property.join("")),e})},n.metaschema_lookup=function(e){e=e.toLowerCase(),e=e.replace(/\W(is|was|are|will be|has been)\W/," "),e=e.replace(/  /g," "),e=e.replace(/_/g," "),e=e.replace(/^\s+|\s+$/,"");var t=i.metaschema.filter(function(t){return t.aliases=t.aliases||[],t.id==e||t.name.toLowerCase()==e||n.isin(e,t.aliases)||t.search.replace(/_/g," ")==e})[0];return t=t||{},t.search},n.singularize=function(e){function t(e,t){return e.length>=t.length&&e.substring(e.length-t.length)==t}function i(e,t){if("string"==typeof e){var o=t.charAt(0).toLowerCase()!=t.charAt(0);return o?e.charAt(0).toUpperCase()+e.substr(1):e}var r=[];for(var n in e){var a=e[n];r.push(i(a,t))}return r}if(e.match(" ")){var o=e.split(" "),r=o[o.length-1],a=o.slice(0,-1);return a.join(" ")+" "+n.singularize(r)}var s={about:1,above:1,across:1,after:1,against:1,along:1,among:1,around:1,at:1,before:1,behind:1,below:1,beneath:1,beside:1,between:1,beyond:1,but:1,by:1,despite:1,down:1,during:1,except:1,"for":1,from:1,"in":1,inside:1,into:1,like:1,near:1,of:1,off:1,on:1,onto:1,out:1,outside:1,over:1,past:1,since:1,through:1,throughout:1,till:1,to:1,toward:1,under:1,underneath:1,until:1,up:1,upon:1,"with":1,within:1,without:1},c=[{p:"people",s:"person"},{p:"tornadoes",s:"tornado"},{p:"churches",s:"church"},{p:"countries",s:"country"},{p:"cities",s:"city"},{p:"companies",s:"company"},{p:"monkies",s:"monkey"},{p:"donkies",s:"donkey"},{p:"mysteries",s:"mystery"},{p:"authors",s:"author"}],l={beef:{anglicized:"beefs",classical:"beeves"},brother:{anglicized:"brothers",classical:"brethren"},child:{anglicized:null,classical:"children"},cow:{anglicized:null,classical:"kine"},ephemeris:{anglicized:null,classical:"ephemerides"},genie:{anglicized:null,classical:"genii"},money:{anglicized:"moneys",classical:"monies"},mongoose:{anglicized:"mongooses",classical:null},mythos:{anglicized:null,classical:"mythoi"},octopus:{anglicized:"octopuses",classical:"octopodes"},ox:{anglicized:null,classical:"oxen"},soliloquy:{anglicized:"soliloquies",classical:null},trilby:{anglicized:"trilbys",classical:null}},p=["fish","ois","sheep","deer","pox","itis"],u={bison:1,flounder:1,pliers:1,bream:1,gallows:1,proceedings:1,breeches:1,graffiti:1,rabies:1,britches:1,headquarters:1,salmon:1,carp:1,herpes:1,scissors:1,chassis:1,"high-jinks":1,"sea-bass":1,seabass:1,clippers:1,homework:1,series:1,cod:1,innings:1,shears:1,contretemps:1,jackanapes:1,species:1,corps:1,mackerel:1,swine:1,debris:1,measles:1,trout:1,diabetes:1,mews:1,tuna:1,djinn:1,mumps:1,whiting:1,eland:1,news:1,wildebeest:1,elk:1,pincers:1,moose:1,shrimp:1,"hoi polloi":1,riffraff:1,rabble:1},m=[{from:"a",to:"ae",words:["alumna","alga","vertebra"]},{from:"a",anglicized:"as",classical:"ae",words:["abscissa","amoeba","antenna","aurora","formula","hydra","hyperbola","lacuna","medusa","nebula","nova","parabola"]},{from:"a",anglicized:"as",classical:"ata",words:["anathema","bema","carcinoma","charisma","diploma","dogma","drama","edema","enema","enigma","gumma","lemma","lymphoma","magma","melisma","miasma","oedema","sarcoma","schema","soma","stigma","stoma","trauma"]},{from:"en",anglicized:"ens",classical:"ina",words:["stamen","foramen","lumen"]},{from:"ex",to:"ices",words:["codex","murex","silex"]},{from:"ex",anglicized:"exes",classical:"ices",words:["apex","cortex","index","latex","pontifex","simplex","vertex","vortex"]},{from:"is",anglicized:"ises",classical:"ides",words:["iris","clitoris"]},{from:"o",to:"os",words:["albino","archipelago","armadillo","commando","ditto","dynamo","embryo","fiasco","generalissimo","ghetto","guano","inferno","jumbo","lingo","lumbago","magneto","manifesto","medico","octavo","photo","pro","quarto","rhino","stylo"]},{from:"o",anglicized:"os",classical:"i",words:["alto","basso","canto","contralto","crescendo","solo","soprano","tempo"]},{from:"on",to:"a",words:["aphelion","asyndeton","criterion","hyperbaton","noumenon","organon","perihelion","phenomenon","prolegomenon"]},{from:"um",to:"a",words:["agendum","bacterium","candelabrum","datum","desideratum","erratum","extremum","stratum","ovum"]},{from:"um",anglicized:"ums",classical:"a",words:["aquarium","compendium","consortium","cranium","curriculum","dictum","emporium","enconium","gymnasium","honorarium","interregnum","lustrum","maximum","medium","memorandum","millenium","minimum","momentum","optimum","phylum","quantum","rostrum","spectrum","speculum","stadium","trapezium","ultimatum","vacuum","velum"]},{from:"us",anglicized:"uses",classical:"i",words:["focus","fungus","genius","incubus","nimbus","nucleolus","radius","stylus","succubus","torus","umbilicus","uterus"]},{from:"us",anglicized:"uses",classical:"us",words:["apparatus","cantus","coitus","hiatus","impetus","nexus","plexus","prospectus","sinus","status"]},{from:"",to:"i",words:["afreet","afrit","efreet"]},{from:"",to:"im",words:["cherub","goy","geraph"]}],d=e.toLowerCase();for(var _ in c)if(c[_].p==e)return c[_].s;for(var f in l){var y=l[f];if(y.anglicized===d||y.classical===d)return i(f,e)}for(var g in p)if(t(d,g))return e;if(u&&u[d])return e;var b=function(o,r,n){if(t(e,r)){var a=e.substring(e.length-r.length),s=a+y.from;for(var c in n)if(s===c)return i(s,e)}return null};for(var h in m){var y=m[h],v="to"in y&&b(y.from,y.to,y.words)||"anglicized"in y&&b(y.from,y.anglicized,y.words)||"classical"in y&&b(y.from,y.classical,y.words);if(null!=v&&"string"==typeof v)return v}for(var k in s){var w=e.indexOf(" "+k+" ");if(w>0){var q=e.substring(0,w),x=singularize(q);return null!=x?x+" "+k+" "+e.substr(w+k.length+2):null}if(w=e.indexOf("-"+k+"-"),w>0){var q=e.substring(0,w),x=singularize(q);return null!=x?x+"-"+k+"-"+e.substr(w+k.length+2):null}}var j=e.lastIndexOf(" ");if(j>0){var x=singularize(e.substring(j+1));return null!=x?e.substring(0,j+1)+x:null}return t(e,"xes")||t(e,"ses")?e.substring(0,e.length-2):t(e,"s")&&!t(e,"ss")?e.substring(0,e.length-1):e},n.sentenceparser=function(e){var t=e.split(/(\S.+?[.])(?=\s+|$)/g),i=[];for(var o in t)t[o]&&(t[o]=t[o].replace(/^\s+|\s+$/g,""),t[o].match(/(^| )(mr|dr|llb|md|bl|phd|ma|ba|mrs|miss|misses|mister|sir|esq|mstr|jr|sr|st|lit|inc|fl|ex|eg|jan|feb|mar|apr|jun|aug|sept?|oct|nov|dec)\. ?$/i)||t[o].match(/[ |\.][a-z]\.?$/i)?t[parseInt(o,10)+1]=t[o]+" "+t[parseInt(o,10)+1]:(i.push(t[o]),t[o]=""));var r=[];for(var n in i)i[n]=i[n].replace(/^\s+|\s+$/g,""),i[n]&&r.push(i[n]);return r},n.json_unique=function(e,t){var i=[];e:for(var o=0;e.length>o;o++){for(var r=0;i.length>r;r++)if(i[r]&&e[o]&&i[r][t]==e[o][t])continue e;i[i.length]=e[o]}return i},n.doit_async=function(t){t.q=t.q||[];var i=t.q.map(function(e){return{q:e,options:t.options,method:t.method}}),o=function(e,t){e.method(e.q,e.options,function(e){t(null,e)})};r.mapLimit(i,e,o,function(e,i){return t.callback(i)})},n.mql_unencode=function(e){return e=e.replace(/\$([0-9A-Fa-f]{4})/g,function(e,t){return String.fromCharCode(parseInt(t,16))})},n.groups_of=function(e,t){var i=[];for(var o in e)0===o%t?i.push([e[o]]):i[i.length-1].push(e[o]);return i},n.parseurl=function(e){for(var t={strictMode:!1,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}},i=t.parser[t.strictMode?"strict":"loose"].exec(e),o={},r=14;r--;)o[t.key[r]]=i[r]||"";return o[t.q.name]={},o[t.key[12]].replace(t.q.parser,function(e,i,r){i&&(o[t.q.name][i]=r)}),o},n.set_params=function(e){var t=e;return t?Object.keys(t).map(function(e){var i=t[e];return(o.isArray(t[e])||o.isObject(t[e]))&&(i=encodeURIComponent(JSON.stringify(t[e]))),e+"="+i}).join("&"):""},n.clone=function(e){return JSON.parse(JSON.stringify(e))},n.http=function(e,i,o){i.key&&(e+="&key="+i.key),t.get(e,o)},n.post=function(e,i,o){var r="query="+JSON.stringify({query:e,key:i.key,cursor:i.cursor});t.post("http://api.freebase.com/api/service/mqlread",r,o)},n.isin=function(e,t){return t.some(function(t){return t==e})},"undefined"!=typeof define&&define.amd?define([],function(){return n}):"undefined"!=typeof module&&module.exports&&(module.exports=n),n}();if("undefined"!=typeof module&&module.exports)var o=require("underscore"),r=require("async"),n=require("./helpers/helpers"),i=require("./helpers/data.js").data;var a=function(){var e={},t={host:"https://www.googleapis.com/freebase/v1/",image_host:"https://usercontent.googleapis.com/freebase/v1/image",geosearch:"http://api.freebase.com/api/service/geosearch",wikipedia_host:"http://en.wikipedia.org/w/api.php",generic_query:{id:null,name:null,mid:null,type:[]}};return e.mqlread=function(e,t,i){return this.doc="interface to freebase's mql api",this.reference="http://wiki.freebase.com/wiki/MQL",i=i||console.log,e?("function"==typeof t&&(i=t,t={}),t=t||{},t.uniqueness_failure=t.uniqueness_failure||"soft",t.cursor=t.cursor||!0,n.post(e,t,function(e){return i(e)}),void 0):i({})},e.lookup_id=function(i,o){this.doc="generic info for an id";var r=n.settle_params(arguments,e.lookup,{type:"/common/topic"});if(r.array)return n.doit_async(r);if(!r.valid)return r.callback({});var a=n.clone(t.generic_query);a.id=r.q,e.mqlread([a],o,function(e){return e=e.result||[],r.callback(e[0]||{})})},e.search=function(){this.doc="regular search api",this.reference="http://wiki.freebase.com/wiki/ApiSearch";var i=n.settle_params(arguments,e.search,{});if(i.array)return n.doit_async(i);if(!i.valid)return i.callback({});if(i.is_id)return e.lookup_id(i.q,i.options,i.callback);if(i.url)return e.url_lookup(i.q,i.options,function(e){return e&&e.result&&e.result[0]?i.callback(e.result[0]):i.callback({})});if(i.is_id)return i.options.limit=1,e.lookup_id(i.q,i.options,i.callback);i.options.query=encodeURIComponent(i.q);var o=n.set_params(i.options),r=t.host+"search/?"+o;("/type/type"==i.options.type||"/type/property"==i.options.type)&&(r+="&scoring=schema&stemmed=true"),n.http(r,i.options,function(e){return e&&e.result&&e.result[0]?i.callback(e.result):i.callback([])})},e.url_lookup=function(){this.doc="freebase search tuned for looking up a url",this.reference="http://wiki.freebase.com/wiki/ApiSearch";var i=n.settle_params(arguments,e.url_lookup,{type:"/common/topic",strict:!0});if(i.array)return n.doit_async(i);if(!i.valid)return i.callback({});var o=n.clone(t.generic_query),r=t.host+"search?type=/common/topic&limit=1&query="+encodeURIComponent(i.q);r+="&mql_output="+encodeURIComponent(JSON.stringify(o)),n.http(r,i.options,function(e){if(!e||!e.result)return i.callback({});var t=e.result||[];return i.callback(t[0])})},e.lookup=function(){this.doc="freebase search with filters to ensure only a confident, unambiguous result",this.reference="http://wiki.freebase.com/wiki/ApiSearch";var o=n.settle_params(arguments,e.lookup,{type:"/common/topic",strict:!0});if(o.array)return n.doit_async(o);if(!o.valid)return o.callback({});if(o.url)return e.url_lookup(o.q,o.options,o.callback);if(o.is_id)return o.options.limit=1,e.lookup_id(o.q,o.options,o.callback);var r=o.options.strength||"full";o.options.strict||(r="word");var a=t.host+"search?limit=2&lang=en&type="+o.options.type+"&filter=",s=n.clone(t.generic_query);return a+=encodeURIComponent("(any name{"+r+'}:"'+o.q+'" alias{'+r+'}:"'+o.q+'")'),("/type/type"==o.options.type||"/type/property"==o.options.type)&&(a+="&scoring=schema&stemmed=true"),a+="&mql_output="+encodeURIComponent(JSON.stringify(s)),n.http(a,o.options,function(e){return e&&e.result&&e.result[0]?(e=e.result||[],e[0]=e[0]||{},e[1]=e[1]||{},!e[0].score&&30>e[0].score?o.callback({}):o.options.strict&&.7*(e[0].score||0)<(e[1].score||0)?o.callback({}):e[1]&&e[0].notable&&n.isin(e[0].notable.id,i.kill)?o.callback({}):(e[0].name=e[0].name||e[0].text||"",o.callback(e[0]))):o.callback({})})},e.get_id=function(){this.doc="like freebase.lookup but satisfied with an id",this.reference="http://wiki.freebase.com/wiki/ApiSearch";
var t=n.settle_params(arguments,e.get_id,{type:"/common/topic"});return t.array?n.doit_async(t):t.valid?t.q&&null==t.q.match(/\/.{1,32}\/.{3}/)?(e.lookup(t.q,t.options,function(e){return e?"/type/type"==t.options.type?(e.mid=e.id,t.callback(e)):e.mid?(e.id=e.id||e.mid,t.callback(e)):t.callback({}):t.callback({})}),void 0):t.callback({id:t.q}):t.callback({})},e.topic=function(){this.doc="topic api",this.reference="http://wiki.freebase.com/wiki/Topic_API";var i=n.settle_params(arguments,e.topic,{});return i.array?n.doit_async(i):i.valid?(e.get_id(i.q,i.options,function(e){var o=e.id;if(!o)return i.callback({});i.options.filter=i.options.filter||"all";var r=t.host+"topic"+o+"?"+n.set_params(i.options);n.http(r,i.options,function(e){return i.callback(e)})}),void 0):i.callback({})},e.paginate=function(t,i,o){this.doc="get all of the results to your query",this.reference="http://wiki.freebase.com/wiki/MQL","function"==typeof i&&(o=i,i={}),i=i||{},o=o||console.log,i.max=i.max||2e3;var r=[],n=function(a){i.cursor=a,e.mqlread(t,i,function(e){return e&&e.result?(r=r.concat(e.result),e.cursor&&(!i.max||r.length<i.max)?(n(e.cursor),void 0):o(r)):o(r)})};n("")},e.description=function(){this.doc="get a text blurb from freebase",this.reference="http://wiki.freebase.com/wiki/ApiText";var i=n.settle_params(arguments,e.description,{});return i.array?n.doit_async(i):i.valid?(e.get_id(i.q,i.options,function(e){if(!e||!e.id)return i.callback("");var o=t.host+"text/"+e.id;n.http(o,i.options,function(e){return e.result?i.callback(e.result):i.callback("")})}),void 0):i.callback({})},e.image=function(){this.doc="get a url for image href of on this topic",this.reference="http://wiki.freebase.com/wiki/ApiImage";var i=n.settle_params(arguments,e.image,{maxheight:250,maxwidth:250,errorid:"/m/0djw4wd"});return i.array?n.doit_async(i):i.valid?(e.get_id(i.q,i.options,function(o){if(!o||!o.id)return i.callback("");var r=[{id:o.id,name:null,"/common/topic/image":[{id:null}]}];e.mqlread(r,i.options,function(e){if(!(e&&e.result&&e.result[0]&&e.result[0]["/common/topic/image"][0]))return i.callback("");var o=t.image_host+e.result[0]["/common/topic/image"][0].id,r=n.set_params(i.options);return o+="?"+r,i.callback(o)})}),void 0):i.callback({})},e.grammar=function(t,r){this.doc="get the proper pronoun to use for a topic eg. he/she/they/it";var a=n.settle_params(arguments,e.grammar,{});return a.array?n.doit_async(a):a.valid?(e.get_id(a.q,a.options,function(t){if(!t||!t.id)return a.callback({});var s=[{id:t.id,name:null,type:[],"/people/person/gender":[{id:null,optional:!0}],"/fictional_universe/fictional_character/gender":[{id:null,optional:!0}]}];e.mqlread(s,r,function(e){if(!e||!e.result||!e.result[0])return a.callback({});e=e.result[0];var t={plural:!1,gender:null,article:"a",pronoun:"it",copula:"is"};if(n.isin("/people/person",e.type)||n.isin("/fictional_universe/fictional_character",e.type)){var r=e["/people/person/gender"][0]||e["/fictional_universe/fictional_character/gender"][0];r?"/en/male"==r.id?(t.gender="male",t.pronoun="he"):"/en/female"==r.id&&(t.gender="female",t.pronoun="she"):(t.gender="unknown",t.pronoun="they")}else o.intersection(i.plural_types,e.type).length>0&&(t.plural=!0,t.pronoun="they",t.copula="are"),o.intersection(i.definate_articles,e.type).length>0&&(t.article="the");return a.callback(t)})}),void 0):a.callback({})},e.same_as_links=function(){this.doc="turns a url into a freebase topic and list its same:as links";var i=n.settle_params(arguments,e.same_as_links,{});if(i.array)return n.doit_async(i);if(!i.valid)return i.callback({});var r=t.host+"search?type=/common/topic&limit=1&query="+encodeURIComponent(i.q);n.http(r,i.options,function(t){return t&&t.result&&t.result[0]?(e.topic(t.result[0].mid,i.options,function(e){if(o.isEmpty(e))return i.callback([]);var r=[];e.property["/common/topic/topic_equivalent_webpage"]&&(r=e.property["/common/topic/topic_equivalent_webpage"].values.map(function(e){return{href:e.value,title:n.parseurl(e.value).authority}})),e.property["/common/topic/topical_webpage"]&&(r=r.concat(e.property["/common/topic/topical_webpage"].values.map(function(e){var t=n.parseurl(e.value).authority||"";return{href:e.value,title:t.replace(/^www\./,"")}})));var a={topic:t.result[0],links:r};return i.callback(a)}),void 0):i.callback({})})},e.translate=function(){this.doc="return specific language title for a topic",this.reference="http://wiki.freebase.com/wiki/I18n";var t=n.settle_params(arguments,e.translate,{lang:"/lang/fr"});return t.array?n.doit_async(t):t.valid?(t.options.lang.match(/\/lang\//)||(t.options.lang="/lang/"+t.options.lang),e.get_id(t.q,t.options,function(i){if(!i||!i.id)return t.callback("");var o=[{id:i.id,name:[{lang:t.options.lang,value:null}]}];e.mqlread(o,{},function(e){if(!e||!e.result||!e.result[0])return t.callback("");var i=e.result[0].name||[{}];return i=i[0].value||"",t.callback(i)})}),void 0):t.callback({})},e.notable=function(){this.doc="get a topic's notable type";var t=n.settle_params(arguments,e.notable,{});return t.array?n.doit_async(t):t.valid?(e.topic(t.q,{filter:"/common/topic/notable_types"},function(e){if(!e||!e.property||!e.property["/common/topic/notable_types"])return t.callback({});var i=e.property["/common/topic/notable_types"]||{values:[]};return i.values[0].name=i.values[0].text,t.callback(i.values[0])}),void 0):t.callback({})},e.sentence=function(){this.doc="get the first sentence of a topic description",this.reference="http://wiki.freebase.com/wiki/APIText";var t=n.settle_params(arguments,e.sentence,{});return t.array?n.doit_async(t):t.valid?(e.description(t.q,t.options,function(e){return e?(e=n.sentenceparser(e)||[],e=e[0]||"",e=e.replace(/\(.*?\)/g,""),e=e.replace(/  /g," "),t.callback(e)):t.callback("")}),void 0):t.callback({})},e.list=function(){this.doc="get a list of topics in a type";var t=n.settle_params(arguments,e.list,{limit:2e3});return t.array?n.doit_async(t):t.valid?(t.q.match(/\/.{1,12}\/.{3}/)||(t.q=n.singularize(t.q)),e.get_id(t.q,{type:"/type/type"},function(i){if(!i||!i.id)return t.callback([]);var o=[{type:i.id,name:null,id:null,mid:null,limit:100}];if(t.options.extend)for(var r in t.options.extend)o[0][r]=t.options.extend[r];e.paginate(o,t.options,t.callback)}),void 0):t.callback([])},e.place_data=function(i,r,a){if(this.doc="from a geo-coordinate, get the town, province, country, and timezone for it",a=a||console.log,!i)return a({});if(r=r||{},o.isArray(i)&&i.length>1)return n.doit_async(i,e.place_data,r,a);var s={coordinates:[i.lng,i.lat],type:"Point"},c=[{mid:null,name:null,type:[]}],l=t.geosearch+"?location="+encodeURIComponent(JSON.stringify(s))+"&order_by=distance&limit=1&type=/location/citytown&within=15&format=json&mql_output="+encodeURIComponent(JSON.stringify(c));n.http(l,r,function(t){var i={city:null,country:null,province:null,timezone:null};i.city=t.result.features[0].properties;var o=[{name:null,id:t.result.features[0].properties.mid,"/location/location/containedby":[{id:null,name:null,type:[],optional:!0,"/location/location/time_zones":[{"/time/time_zone/offset_from_uct":null,id:null,name:null,optional:!0}],"/location/location/containedby":[{id:null,name:null,type:[],optional:!0,"/location/location/time_zones":[{"/time/time_zone/offset_from_uct":null,id:null,name:null,optional:!0}]}]}]}];e.mqlread(o,{},function(e){for(var t in e.result[0]["/location/location/containedby"]){var o=e.result[0]["/location/location/containedby"][t];if(o.type.filter(function(e){return"/location/country"==e})[0]?i.country={id:o.id,name:o.name}:o.type.filter(function(e){return"/location/administrative_division"==e})[0]&&(i.province={id:o.id,name:o.name}),o["/location/location/time_zones"][0]&&1==o["/location/location/time_zones"].length&&(i.timezone=o["/location/location/time_zones"][0]),i.country)return a(i);o["/location/location/containedby"].map(function(e){e.type.filter(function(e){return"/location/country"==e})[0]?i.country={id:e.id,name:e.name}:!i.province&&e.type.filter(function(e){return"/location/administrative_division"==e})[0]&&(i.province={id:e.id,name:e.name}),!i.timezone&&e["/location/location/time_zones"][0]&&1==e["/location/location/time_zones"].length&&(i.timezone=e["/location/location/time_zones"][0])})}return a(i)})})},e.incoming=function(){this.doc="get any incoming data to this topic, ignoring cvt types";var t=n.settle_params(arguments,e.incoming,{});return t.array?n.doit_async(t):t.valid?(e.get_id(t.q,t.options,function(i){if(!i||!i.id)return t.callback([]);var o=[{id:i.id,"/type/reflect/any_reverse":[{link:null,id:null,name:null,type:"/common/topic",limit:170}]}];e.paginate(o,t.options,function(e){return e&&e[0]&&e[0]["/type/reflect/any_reverse"]?t.callback(e[0]["/type/reflect/any_reverse"]):t.callback([])})}),void 0):t.callback({})},e.outgoing=function(){this.doc="return all outgoing links for a topic, traversing cvt types";var t=n.settle_params(arguments,e.outgoing,{});return t.array?n.doit_async(t):t.valid?(e.lookup(t.q,t.options,function(r){return r&&r.mid?(e.topic(r.mid,t.options,function(e){if(o.isEmpty(e))return t.callback([]);var a=[];return e.property=n.kill_boring(e.property),Object.keys(e.property).forEach(function(t){var i=e.property[t];"object"==i.valuetype&&(i.values=i.values.map(function(e){return e.property=t,e}),a=a.concat(i.values)),"compound"==i.valuetype&&i.values.forEach(function(e){e.property=n.kill_boring(e.property),Object.keys(e.property).forEach(function(i){"object"==e.property[i].valuetype&&(e.property[i].values=e.property[i].values.map(function(e){return e.property=[t,i],e}),a=a.concat(e.property[i].values))})})}),a=a.map(function(e){return{name:e.text,id:e.id,property:e.property}}),a=a.map(function(e){var t=e.property||"";o.isArray(e.property)&&(t=e.property.join("")),e.sentence=r.name+"'s "+o.last(t.split("/")).replace("_"," ")+" is "+e.name;var n=i.sentence_grammars.filter(function(e){return e.id==t})[0]||{};return n.sen&&r.name&&e.name&&(e.sentence=n.sen.replace(/\bsubj\b/,r.name).replace(/\bobj\b/,e.name)),e}),t.callback(a)}),void 0):t.callback([])}),void 0):t.callback({})},e.graph=function(){this.doc="return all outgoing and incoming links for a topic";var t=n.settle_params(arguments,e.graph,{});return t.array?n.doit_async(t):t.valid?(e.lookup(t.q,t.options,function(r){return r?(delete r.score,delete r.lang,t.options.filter="allproperties",e.topic(r.mid,t.options,function(e){if(!e||!e.property)return t.callback([]);var a={},s={};Object.keys(e.property).forEach(function(t){t.match(/^\!/)?s[t]=e.property[t]:a[t]=e.property[t]}),a=n.parse_topic_api(a),s=n.parse_topic_api(s);var c=a.map(function(e){return{subject:r,property:{id:e.property},object:e,direction:"outgoing"}});return c=c.concat(s.map(function(e){return{object:r,property:{id:e.property},subject:e,direction:"incoming"}})),c=c.map(function(e){e.property.id=e.property.id.replace(/^\!/,""),delete e.subject.property;var t=i.sentence_grammars.filter(function(t){return t.id==e.property.id})[0]||{};return e.sentence=e.subject.name+"'s "+o.last(e.property.id.split("/")).replace("_"," ")+" is "+e.object.name,t.sen&&e.subject.name&&e.object.name&&(e.sentence=t.sen.replace(/\bsubj\b/,e.subject.name).replace(/\bobj\b/,e.object.name)),e}),t.callback(c)}),void 0):t.callback({})}),void 0):t.callback({})},e.related=function(t,r){this.doc="get similar topics to a topic";var a=n.settle_params(arguments,e.related,{});if(a.array)return n.doit_async(a);if(!a.valid)return a.callback({});var s=[];e.outgoing(a.q,a.options,function(t){return s=t.filter(function(e){return n.isin(e.property,i.related_properties)}),s=s.sort(function(){return Math.round(Math.random())-.5}),s=s.map(function(e){return e.sentence||(e.sentence=e.name+" is related to "+t.name),e}),s=n.json_unique(s,"id"),s.length>=r.max?a.callback(s):(e.notable(a.q,a.options,function(t){return t&&t.id?e.list(t.id,{max:a.options.max},function(e){return!e||o.isEmpty(e)?a.callback(s):(e=e.map(function(e){return e.sentence=e.name+" is also a "+t.name,e}),s=s.concat(e),s=n.json_unique(s,"id"),s=s.sort(function(){return Math.round(Math.random())-.5}),a.callback(s))}):a.callback(s)}),void 0)})},e.is_a=function(){this.doc="get a list of identifiers for a topic";var t=n.settle_params(arguments,e.related,{max:25});return t.array?n.doit_async(t):t.valid?(e.topic(t.q,t.options,function(e){if(o.isEmpty(e))return t.callback({});var r=e.property["/type/object/type"]||{};return r=r.values||[],r=r.filter(function(e){return!e.text.match(/Topic/)}),r=r.map(function(e){return{name:e.text,id:e.id,property:"/type/object/type"}}),e=n.parse_topic_api(e.property),e=e.filter(function(e){return n.isin(e.property,i.is_a)}),e=e.concat(r),t.callback(e)}),void 0):t.callback({})},e.property_lookup=function(t){this.doc="lookup soft property matches, like 'birthday' vs 'date of birth'";var o=n.settle_params(arguments,e.property_lookup,{type:"/type/property"});return o.array?n.doit_async(o):o.valid?(e.search(o.q,o.options,function(e){if(!t.match(/\/.*?\/.*?\//)){t=t.toLowerCase(),t=t.replace(/  /," "),t=t.replace(/^\s+|\s+$/,"");var r=n.singularize(t);e=e.concat(i.properties.filter(function(e){return e.n==t||e.n==r}))}return o.callback(e)}),void 0):o.callback({})},e.question=function(t,i){this.doc="give a topic and a property, and get a list of results";var r=n.settle_params(arguments,e.question,{max:25});if(r.array)return n.doit_async(r);if(!r.valid||!r.options.property)return r.callback({});var a=r.options.property,s=r.options.property.match(/\/.*?\/.*?\//);if(a.match(/^\/.{1,12}\/.{3}/))return e.topic(t,{},function(e){return e&&e.property&&e.property[a]?r.callback(e.property[a].values):r.callback([])});var c=n.metaschema_lookup(a);c?(r.options.filter="(all "+c+':"'+t+'")',e.search("",i,function(e){return r.callback(e)})):e.property_lookup(a,{},function(t){return 0===t.length?r.callback([]):(r.options.filter=s,e.topic(r.q,r.options,function(e){if(o.isEmpty(e))return r.callback({});var i=[];return t.forEach(function(t){e.property[t.id]&&(i=i.concat(e.property[t.id].values))}),i=n.json_unique(i,"id"),r.callback(i)}),void 0)})},e.dig=function(){this.doc="transitive query on a specific property, maximum 3-ply";var t=n.settle_params(arguments,e.property_lookup,{max:25});if(t.array)return n.doit_async(t);if(!t.valid)return t.callback({});var i=[];e.question(t.q,t.options,function(r){return r&&o.isArray(r)&&0!==r.length?(i=i.concat(r),r=r.slice(0,t.options.max).map(function(e){return e.id}),n.doit_async({q:r,options:t.options,method:e.question,callback:function(a){return a&&o.isArray(a)&&0!==a.length?(i=i.concat(o.flatten(a,"shallow")),i=n.json_unique(i,"id"),n.doit_async(r,e.question,t.options,function(e){return e&&o.isArray(e)&&0!==e.length?(i=i.concat(o.flatten(e,"shallow")),i=n.json_unique(i,"id"),t.callback(i)):t.callback(i)}),void 0):t.callback(i)}})):t.callback(i)})},e.gallery=function(){this.doc="list of topics with images";var i=n.settle_params(arguments,e.gallery,{extend:{"/common/topic/image":[{id:null,optional:"required"}]}});return i.array?n.doit_async(i):i.valid?(e.list(i.q,i.options,function(r){return r=r.map(function(i){return i.href=t.image_host+o.last(i["/common/topic/image"]).id,i.thumbnail=t.image_host+o.last(i["/common/topic/image"]).id+"?mode=fillcropmid&maxwidth=150&maxheight=150&errorid=/m/0djw4wd",i=e.add_widget(i)}),i.callback(r)}),void 0):i.callback({})},e.wordnet=function(){this.doc="query wordnet via freebase";var t=n.settle_params(arguments,e.wordnet,{});if(t.array)return n.doit_async(t);if(!t.valid)return t.callback({});var i=[{id:null,type:"/base/wordnet/synset",gloss:null,syntactic_category:null,sort:["syntactic_category","word.sense_number","a:word.word_number"],word:{sense_number:null,derivationally_related_forms:[{sense:{name:null,id:null},optional:!0}],word:{word:t.q}},"a:word":[{word_number:null,word:{word:null}}]}];t.options.limit&&(i[0].limit=t.options.limit),e.mqlread(i,t.options,function(e){return t.callback(e.result)})},e.transitive=function(t,i){this.doc="do a transitive-query, like all rivers in canada, using freebase metaschema";var o=n.settle_params(arguments,e.transitive,{});return o.array?n.doit_async(o):o.valid?(e.get_id(o.q,o.options,function(t){if(!t||!t.id)return o.callback({});var r=n.metaschema_lookup(o.options.property);return r?(i.filter="(all "+r+':"'+t.id+'")',e.search("",o.options,function(e){return o.callback(e)}),void 0):o.callback([])}),void 0):o.callback({})},e.geolocation=function(){this.doc="lat/long for a topic";var t=n.settle_params(arguments,e.geolocation,{type:"/location/location"});return t.array?n.doit_async(t):t.valid?(e.get_id(t.q,t.options,function(i){if(!i||!i.id)return t.callback({});var o=[{id:i.id,name:null,"/location/location/geolocation":[{latitude:null,longitude:null,type:"/location/geocode",optional:!0}]}];e.mqlread(o,t.options,function(e){if(e.result&&e.result[0]&&e.result[0]["/location/location/geolocation"][0]){var i=e.result[0]["/location/location/geolocation"][0];return delete i.type,delete i.optional,t.callback(i)}return t.callback({})})}),void 0):t.callback({})},e.nearby=function(){this.doc="list of topics nearby a location";var i=n.settle_params(arguments,e.nearby,{});return i.array?n.doit_async(i):i.valid?(e.geolocation(i.q,{},function(e){if(!e||!e.latitude||!e.longitude)return i.callback([]);var o='{"coordinates":['+e.longitude+","+e.latitude+'],"type":"Point"}';i.options.within=i.options.within||5,i.options.type=i.options.type||"/location/location";var r=t.geosearch+"?location="+encodeURIComponent(o)+"&order_by=distance&type="+i.options.type+"&within="+i.options.within+"&limit=200&format=json";n.http(r,i.options,function(e){return i.callback(e.result.features)})}),void 0):i.callback({})},e.inside=function(){this.doc="list of topics inside a location";var t=n.settle_params(arguments,e.inside,{property:"part_of"});return t.array?n.doit_async(t):t.valid?(t.options.mql_output=t.options.mql_output||[{name:null,id:null,type:"/location/location","/location/location/geolocation":[{latitude:null,longitude:null,type:"/location/geocode",optional:!0}]}],e.transitive(t.q,t.options,function(e){return t.callback(e)}),void 0):t.callback({})},e.wikipedia_page=function(){this.doc="get a url for wikipedia based on this topic";var t=n.settle_params(arguments,e.wikipedia,{});return t.array?n.doit_async(t):t.valid?(e.get_id(t.q,t.options,function(i){if(!i||!i.id)return t.callback("");var o=[{id:i.id,name:null,key:{namespace:"/wikipedia/en_title",value:null}}];e.mqlread(o,t.options,function(e){return e&&e.result&&e.result[0]?t.callback("http://en.wikipedia.org/wiki/"+n.mql_unencode(e.result[0].key.value)):t.callback("")})}),void 0):t.callback({})},e.dbpedia_page=function(){this.doc="get a url for dbpedia based on this topic";var t=n.settle_params(arguments,e.dbpedia,{});return t.array?n.doit_async(t):t.valid?(e.get_id(t.q,t.options,function(i){if(!i||!i.id)return t.callback("");var o=[{id:i.id,name:null,key:{namespace:"/wikipedia/en_title",value:null}}];e.mqlread(o,t.options,function(e){if(!e||!e.result||!e.result[0])return t.callback({});var i=n.mql_unencode(e.result[0].key.value),o={html:"http://dbpedia.org/page/"+i,json:"http://dbpedia.org/data/"+i+".json"};return t.callback(o)})}),void 0):t.callback({})},e.wikipedia_categories=function(i,o){this.doc="get the wikipedia categories for a topic";var r=n.settle_params(arguments,e.wikipedia_categories,{});if(r.array)return n.doit_async(r);if(!r.valid)return r.callback({});if(r.q.match(/ /)||r.q.substr(0,1)==r.q.substr(0,1).toLowerCase()||r.q.match(/^\//))return e.wikipedia_page(r.q,o,function(t){e.wikipedia_categories(t,o,r.callback)});var a=t.wikipedia_host+"?action=query&prop=categories&format=json&clshow=!hidden&cllimit=200&titles="+encodeURIComponent(r.q);n.http(a,r.options,function(e){if(!(e&&e.query&&e.query.pages&&e.query.pages[Object.keys(e.query.pages)[0]]))return r.callback([]);var t=e.query.pages[Object.keys(e.query.pages)[0]].categories||[];return t=t.map(function(e){return e.title}),r.callback(t)})},e.wikipedia_links=function(i,r,a){if(this.doc="outgoing links from this wikipedia page, converted to freebase ids",a=a||console.log,!i)return a({});if("function"==typeof r&&(a=r,r={}),r=r||{},o.isArray(i)&&i.length>1)return n.doit_async(i,e.wikipedia_links,r,a);if(i.match(/ /)||i.substr(0,1)==i.substr(0,1).toLowerCase()||i.match(/^\//))return e.wikipedia_page(i,r,function(t){e.wikipedia_links(t,r,a)});var s=t.wikipedia_host+"?action=query&prop=links&format=json&plnamespace=0&pllimit=500&titles="+encodeURIComponent(i);n.http(s,ps.options,function(t){if(!(t&&t.query&&t.query.pages&&t.query.pages[Object.keys(t.query.pages)[0]]))return a([]);var i=t.query.pages[Object.keys(t.query.pages)[0]].links||[];return i=i.filter(function(e){return null==e.title.match(/^List of /i)}),i=i.map(function(t){return t.id="/wikipedia/en/"+e.mql_encode(t.title.replace(/ /g,"_")),t.name=t.title,delete t.title,delete t.ns,t}),a(i)})},e.wikipedia_external_links=function(i,r,a){if(this.doc="outgoing links from this wikipedia page, converted to freebase ids",a=a||console.log,!i)return a({});if("function"==typeof r&&(a=r,r={}),r=r||{},o.isArray(i)&&i.length>1)return n.doit_async(i,e.wikipedia_external_links,r,a);if(i.match(/ /)||i.substr(0,1)==i.substr(0,1).toLowerCase()||i.match(/^\//))return e.wikipedia_page(i,r,function(t){e.wikipedia_external_links(t,r,a)});var s=t.wikipedia_host+"?action=query&prop=extlinks&format=json&plnamespace=0&pllimit=500&titles="+encodeURIComponent(i);n.http(s,ps.options,function(e){if(!(e&&e.query&&e.query.pages&&e.query.pages[Object.keys(e.query.pages)[0]]))return a([]);var t=e.query.pages[Object.keys(e.query.pages)[0]].extlinks||[];return t=t.filter(function(e){return e["*"].match(/^http/)}),t=t.map(function(e){var t=n.parseurl(e["*"]);return{url:e["*"],domain:t.host}}),a(t)})},e.schema=function(t,i,r){return this.doc="common lookups for types and properties",r=r||console.log,t?("function"==typeof i&&(r=i,i={}),i=i||{},o.isArray(t)&&t.length>1?n.doit_async(t,e.schema,i,r):(e.search(t,{type:"/type/type"},function(i){if(i&&i[0]&&i[0].id){i=i[0];var o=[{id:i.id,mid:null,name:null,properties:[{id:null,name:null,"/type/property/reverse_property":[{id:null,name:null,optional:!0}]}],"/freebase/type_hints/mediator":null,"/freebase/type_hints/included_types":[{id:null,name:null}],"/freebase/type_profile/published":null,"/type/type/expected_by":[{id:null,name:null}],"/freebase/type_profile/instance_count":null,"/freebase/type_profile/property_count":null,domain:{id:null,name:null},"/freebase/type_profile/equivalent_topic":{id:null,name:null},type:"/type/type"}];e.mqlread(o,{},function(t){if(!t||!t.result||!t.result[0])return r({});t=t.result[0];var i={};i.domain=t.domain,i.id=t.id,i.included_types=t["/freebase/type_hints/included_types"],i.incoming_properties=t["/type/type/expected_by"],i.is_compound_value=t["/freebase/type_hints/mediator"]||!1,i.is_commons=t["/freebase/type_profile/published"]||!1,i.equivalent_topic=t["/freebase/type_profile/equivalent_topic"],i.topic_count=t["/freebase/type_profile/instance_count"]||0,i.property_count=t["/freebase/type_profile/property_count"]||0;var o=[{id:null,name:null,"s:name":{value:null,lang:"/lang/en",optional:"required"},"/freebase/type_hints/included_types":[{id:i.id}]}];e.mqlread(o,{},function(e){return e&&e.result?(i.included_by=e.result.map(function(e){return{id:e.id,name:e.name}}),r(i)):r(i)})})}else e.property_lookup(t,{},function(t){return t&&t[0]&&t[0].id?e.property_inspection(t[0].id,{},r):r({})})}),void 0)):r({})},e.property_introspection=function(t,i,r){if(this.doc="common lookups for freebase property data",r=r||console.log,!t)return r({});if("function"==typeof i&&(r=i,i={}),i=i||{},o.isArray(t)&&t.length>1)return n.doit_async(t,e.property_introspection,i,r);var a=[{id:t,mid:null,name:null,type:"/type/property",reverse_property:[{id:null,name:null,optional:!0}],expected_type:[{id:null,name:null,optional:!0,"/freebase/type_hints/mediator":null}],unique:null,schema:{id:null,name:null,"/freebase/type_profile/instance_count":null,"/freebase/type_hints/mediator":null},"/common/topic/description":null}];e.mqlread(a,i,function(o){var n={};if(!o||!o.result||!o.result[0])return r(n);o=o.result[0],n.name=o.name,n.id=o.id,n.type=o.schema,n.description=o["/common/topic/description"],n.unique=o.unique||!1,n.reverse_property=o.reverse_property,n.expected_type=o.expected_type;var a=[{name:null,type:"/base/fbontology/semantic_predicate",paths:{"a:properties":t,"b:properties":[{id:null}]}}];e.mqlread(a,i,function(e){return n.meta=e.result,r(n)})})},e.drilldown=function(t,i){this.doc="get insight into the breakdown of the topics in this type, by type and quality";var r=n.settle_params(arguments,e.drilldown,{limit:1e3});return r.array?n.doit_async(r):r.valid?(r.q.match(/\/.{1,12}\/.{3}/)||(r.q=n.singularize(r.q)),e.get_id(r.q,{type:"/type/type"},function(t){if(!t||!t.id)return r.callback([]);var a=[{"s:type":t.id,type:[],name:null,id:null,limit:150,"estimate-count":null,"/common/topic/image":[{id:null,limit:1,optional:!0}],key:[{namespace:"/wikipedia/en",limit:1,value:null,optional:!0}],"/common/topic/alias":[{value:null,limit:1,optional:!0}]}];if(i.extend)for(var s in i.extend)a[0][s]=i.extend[s];e.paginate(a,r.options,function(e){var t=o.flatten(e.map(function(e){return e.type}));t=t.filter(function(e){return!e.match(/\/topic$/)});var i=n.topk(t,e.length),a=e.filter(function(e){return e["/common/topic/alias"].length>0}),s=e.filter(function(e){return e["/common/topic/image"].length>0}),c=e.filter(function(e){return e.key.length>0}),l={types:i,alias_percent:n.percentage(a.length,e.length),image_percent:n.percentage(s.length,e.length),wikipedia_percent:n.percentage(c.length,e.length),subset:e.length,"estimate-count":e[0]["estimate-count"]};r.callback(l)})}),void 0):r.callback([])},e.mql_encode=function(e){if(this.doc="quote a unicode string to turn it into a valid mql /type/key/value",!e)return"";e=e.replace(/  /," "),e=e.replace(/^\s+|\s+$/,""),e=e.replace(/ /g,"_");var t="A-Za-z0-9",i="A-Za-z0-9_-",o=RegExp("^["+t+"]["+i+"]*$"),r=RegExp("([^"+i+"])","g");if(o.exec(e))return e;var n=function(e,t){var i=t.charCodeAt(0).toString(16).toUpperCase();return 2==i.length&&(i="00"+i),3==i.length&&(i="0"+i),"$"+i},a=e.replace(r,n);return("-"==a.charAt(0)||"_"==a.charAt(0))&&(a=n(a,a.charAt(0))+a.substr(1)),a},e.category_list=function(){function i(s,c){var l=t.wikipedia_host+"?action=query&list=categorymembers&format=json&cmlimit=400&cmtitle="+encodeURIComponent(s)+"&cmcontinue="+c;n.http(l,o.options,function(t){if(!(t&&t.query&&t.query.categorymembers&&t.query.categorymembers[Object.keys(t.query.categorymembers)[0]]))return o.callback([]);a=a.concat(t.query.categorymembers.filter(function(e){return 14==e.ns}));var n=t["query-continue"]||{};n=n.categorymembers||{},n=n.cmcontinue||"";var c=t.query.categorymembers.filter(function(e){return 0==e.ns});return c=c.map(function(t){return{id:"/wikipedia/en/"+e.mql_encode(t.title),article:"http://en.wikipedia.org/wiki/index.html?curid="+t.pageid,title:t.title}}),r=r.concat(c),n?(i(s,n),void 0):o.callback(r)})}this.doc="get the freebase topics in a wikipedia category";var o=n.settle_params(arguments,e.category_list,{depth:1});if(o.array)return n.doit_async(o);if(!o.valid)return o.callback({});o.q.match(/Category:/)||(o.q="Category:"+o.q);var r=[],a=[];i(o.q,"")},e.wikipedia_subcategories=function(){this.doc="find the subcategories of this wikipedia category";var i=n.settle_params(arguments,e.wikipedia_subcategories,{depth:1,already:[]});if(i.array)return n.doit_async(i);if(!i.valid)return i.callback({});i.q.match(/Category:/)||(i.q="Category:"+i.q);var r=t.wikipedia_host+"?action=query&list=categorymembers&format=json&cmlimit=400&cmnamespace=14&cmtitle="+encodeURIComponent(i.q);n.http(r,i.options,function(t){if(!(t&&t.query&&t.query.categorymembers&&t.query.categorymembers[Object.keys(t.query.categorymembers)[0]]))return i.callback([]);var r=t.query.categorymembers.map(function(e){return e.title});return r=r.filter(function(e){return!n.isin(e,i.options.already)}),i.options.already=n.compact_strong(o.flatten(i.options.already.concat(r))),i.options.depth>1&&r.length>0?(i.options.depth=i.options.depth-1,e.wikipedia_subcategories(r,i.options,function(e){return i.options.already=i.options.already.concat(e),i.callback(n.compact_strong(o.flatten(i.options.already)))})):i.callback(i.options.already)})},e.rdf=function(){this.doc="RDF api",this.reference="http://wiki.freebase.com/wiki/RDF";var i=n.settle_params(arguments,e.topic,{});return i.array?n.doit_async(i):i.valid?(e.get_id(i.q,i.options,function(e){var o=e.id;if(!o)return i.callback({});i.options.filter=i.options.filter||"all";var r=t.host+"rdf"+o;n.http(r,i.options,function(e){return i.callback(e.body||"")})}),void 0):i.callback({})},e.wikipedia_to_freebase=function(){this.doc="turn a wikipedia title or url into a freebase topic";var t=n.settle_params(arguments,e.wikipedia_to_freebase,{depth:1});if(t.array)return n.doit_async(t);if(!t.valid)return t.callback({});t.q=t.q.replace(/^https?:\/\/..\.wikipedia\.org\/wiki\//,"");var i=t.q,o={id:"/wikipedia/en/"+e.mql_encode(t.q),title:i};return t.callback(o)},e.add_widget=function(e){if(this.doc="add a generic html view of a topic",!e||!i)return e;var i=e.mid||e.id,o='<a href="#" class="imagewrap" data-id="'+i+'" style="position:relative; width:200px; height:200px;">'+'<img style="border-radius:5px;" src="'+t.image_host+i+'?maxwidth=200&maxheight=200&errorid=/m/0djw4wd"/>';return e.name&&(o+='<div class="caption" style="position:absolute; opacity:0.5; background:black; bottom:10px; color:white; left:10px; border-radius: 5px; min-width:100px; padding:5px;">'+e.name+"</div>"),o+="</a>",e.widget=o,e},e.documentation=function(t,i,o){o=o||console.log,i=i||{};var r=[];if(r.push("Freebase.com nodejs-library"),r.push("https://github.com/spencermountain/Freebase-nodejs--"),t){if(e[t]){r.push(" * "+t);var t=new e[t];return r.push(t.doc),void 0}r.push("Couldn't find the function "+t+". Here are the available functions:")}Object.keys(e).map(function(t){r.push("* **"+t+"** ");var t=new e[t](null,{},function(){});r.push("     -"+t.doc)}),r=i.html?r.join("<br/>"):r.join("\n"),o(r)},"undefined"!=typeof define&&define.amd?define([],function(){return e}):"undefined"!=typeof module&&module.exports&&(module.exports=e),e}();return a}()})(jQuery);